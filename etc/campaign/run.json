[
    {
        "$class": "redis",
        "$method": "getHash",
        "key": "{$job.data}",
        "$set": "campaignObj"
    },
    {
        "$class": "redis",
        "$method": "setValue",
        "key": "{$job.data}",
        "property": "status",
        "value": "Started"
    },
    {
        "$class": "redis",
        "$method": "publish",
        "channel": "opxi2.campaign.change.{$job.data}",
        "message": "{$job.data}"
    },
    {
        "$function": "console.print",
        "$args": [ "Process Campaign: ", "{$campaignObj}" ]
    },
    {
        "$class": "redis",
        "$method": "pages",
        "key": "{$campaignObj.targets}",
        "pageSize": "100",
        "$set": "pages",
        "$empty": "no_results"
    },
    {
        "if": "{$no_results}",
        "$function": "console.print",
        "$args": [ "No Destinations!: ", "{$campaignObj.targets}" ]
    },
    {
        "$every": "{$pages}",
        "$collect": "outbound_jobs",
        "$tasks": [
            {
                "$class": "redis",
                "$method": "paged",
                "key": "{$campaignObj.targets}",
                "page": "{#every.item}",
                "pageSize": "100",
                "$set": "destinations"
            },
            {
                "$every": "{#destinations}",
                "$collect": "outbound_job",
                "$tasks": [
                    {
                        "$function": "console.print",
                        "$args": [ "Outbound Request to: ", "{#every.item}" ]
                    },
                    {
                        "$class": "message",
                        "$method": "from_campaign",
                        "dest": "{#every.item}",
                        "campaign": "{$campaignObj}",
                        "$set": "msg"
                    },
                    {
                        "$class": "job",
                        "name": "outbound-msg",
                        "data": "{#msg}",
                        "$set": "outbound_job"
                    },





                    {
                        "if": "{#outbound_msg_result}",
                        "$class": "redis",
                        "$method": "setValue",
                        "key": "{$campaignObj.targets_log}",
                        "property": "{#every.item}",
                        "value": "{#outbound_msg_result}"
                    },
                    {
                        "if": "{#outbound_msg_result}",
                        "$class": "redis",
                        "$method": "incr",
                        "key": "{$campaignObj.successes}",
                        "$set": "newValue"
                    },
                    {
                        "$class": "redis",
                        "$method": "publish",
                        "channel": "opxi2.campaign.change.{$job.data}",
                        "message": "{$job.data}"
                    }







                ],
                "$set": "outbound_jobs"
            }
        ],
        "$set": "campaign_result"
    },
    {
        "if": "{$campaign_result}",
        "$class": "redis",
        "$method": "setValue",
        "key": "{$job.data}",
        "property": "status",
        "value": "Complete"
    },
    {
        "if": "{$campaign_result}",
        "$class": "redis",
        "$method": "publish",
        "channel": "opxi2.campaign.change.{$job.data}",
        "message": "{$job.data}"
    }
]