[
    {
        "$class": "redis",
        "$method": "getHash",
        "key": "{$message}",
        "$set": "campaignHash"
    },
    {
        "$class": "message",
        "$method": "as_campaign",
        "id": "{$message}",
        "data": "{$campaignHash}",
        "$set": "campaign"
    },
    {
        "$class": "couch",
        "id": "{$campaign.id}",
        "doc": "{$campaign}",
        "$set": "logResp"
    },
    {
        "if": "{$logResp}",
        "$class": "job",
        "blocking": true,
        "name": "authorize-msg",
        "data": "{$campaign}",
        "$set": "auth"
    },
    {
        "if": "{$auth.success}",
        "$class": "job",
        "name": "campaign-run",
        "data": "{$campaign.id}",
        "$set": "job_id"
    },
    {
        "if": "{$job_id}",
        "$class": "redis",
        "$method": "setValue",
        "key": "{$message}",
        "property": "job_id",
        "value": "{$job_id}"
    },
    {
        "if": "{$auth.success}",
        "$class": "redis",
        "$method": "setValue",
        "key": "{$message}",
        "property": "status",
        "value": "queued"
    },
    {
        "if": "{$auth.success}",
        "$class": "redis",
        "$method": "publish",
        "channel": "opxi2.campaign.change.{$message}",
        "message": "{$message}"
    },
    {
        "if": "{$auth.failed}",
        "$class": "redis",
        "$method": "setValue",
        "key": "{$message}",
        "property": "status",
        "value": "not_authorized"
    },
    {
        "if": "{$auth.failed}",
        "$class": "redis",
        "$method": "publish",
        "channel": "opxi2.campaign.change.{$message}",
        "message": "{$message}"
    }
]