[
    {
        "$class": "atm_event",
        "$method": "event_branch",
        "eventId": "{$job.data.id}",
        "$set": "branch"
    },
    {
        "$class": "crm",
        "$method": "cells",
        "sort_by": "customfields.alarm_priority",
        "query": "org_unit",
        "value": "{$branch.id}",
        "$set": "branch_cells",
        "$empty": "no_cells"
    },
    {
        "$class": "crm",
        "$method": "event_matches",
        "label": "worktime",
        "$set": "at_work",
        "$empty": "off_work"
    },
    {
        "if": "{$off_work}",
        "$class": "crm",
        "$method": "homes",
        "sort_by": "customfields.alarm_priority",
        "query": "org_unit",
        "value": "{$branch.id}",
        "$set": "branch_phones",
        "$empty": "no_phones"
    },
    {
        "if": "{$at_work}",
        "$class": "crm",
        "$method": "phones",
        "sort_by": "customfields.alarm_priority",
        "query": "org_unit",
        "value": "{$branch.id}",
        "$set": "branch_phones",
        "$empty": "no_phones"
    },
    {
        "if": [ "{$no_cells}", "{$no_phones}" ],
        "$class": "util",
        "$method": "set",
        "name":["error", "message"],
        "value":[true, "No Contact Addresses"],
        "$set": "alarm_answered"
    },
    {
        "if": [ "{$branch_cells}", "{$branch_phones}"],
        "$function": "Array.prototype.concat",
        "$args": [ "{$branch_cells}", "{$branch_phones}" ],
        "$set": "branch_contacts"
    },
    {
        "if": [ "{$no_cells}", "{$branch_phones}"],
        "$function": "Array.prototype.concat",
        "$args": [ "{$branch_phones}" ],
        "$set": "branch_contacts"
    },
    {
        "if": [ "{$branch_cells}", "{$no_phones}"],
        "$function": "Array.prototype.concat",
        "$args": [ "{$branch_cells}" ],
        "$set": "branch_contacts"
    },
    {
        "if": "{$branch_contacts}",
        "$class": "message",
        "$method": "as_alarm_msg",
        "alarm_id": "{$job.data.id}",
        "media_url": "{$job.data.alarm.media_url}",
        "destinations": "{$branch_contacts}",
        "answer_timeout": 30,
        "$set": "multi_msg_alarm"
    },
    {
        "if": "{$multi_msg_alarm}",
        "$class": "atm_event",
        "$method": "update",
        "eventId":"{$job.data.id}",
        "status":"sending alarm"
    },
    {
        "$class": "atm_event",
        "$method": "event_atm",
        "eventId": "{$job.data.id}",
        "$set": "atm"
    },
    {
        "$class": "util",
        "$method": "set",
        "name":[ "atm" ],
        "value":[ "{$atm}" ],
        "$set": "context_data"
    },
    {
        "$class": "util",
        "$method": "set",
        "base": "{$multi_msg_alarm}",
        "name":["__context_data"],
        "value":["{$context_data}"],
        "$set": "final_msg"
    },
    {
        "$class": "job",
        "name": "outbound-notify-first",
        "blocking": true,
        "$retries": "{$branch_contacts.length}",
        "$priority": "high",
        "data": "{$final_msg}",
        "$set": "alarm_answered"
    }
]