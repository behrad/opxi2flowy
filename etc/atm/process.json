[
    {
        "$class": "atm_event",
        "$method": "process",
        "event": "{$job.data}",
        "job_id": "{$job.id}",
        "$set": "failure"
    },
    {
        "$class": "job",
        "$method": "progress",
        "job": "{$job}",
        "level": 10
    },
    {
        "$class": "job",
        "$method": "log",
        "job": "{$job}",
        "format": "Processed: %s",
        "args": [ "{$failure}" ]
    },
    {
        "if": "{$failure.new}",
        "$class": "crm",
        "$method": "event_matches",
        "label": "alarmtime",
        "$set": "in_time",
        "$empty": "no_alarm"
    },
    {
        "if": "{$no_alarm}",
        "$class": "util",
        "$method": "set",
        "base":"{$failure}",
        "name":"message",
        "value":"not in alarm time",
        "$set": "failure_result"
    },
    {
        "if": "{$no_alarm}",
        "$class": "atm_event",
        "$method": "update",
        "eventId":"{$failure.id}",
        "estate": "not_alarm_time",
        "status":"Not in alarm time"
    },
    {
        "if": "{$no_alarm}",
        "$class": "job",
        "$method": "log",
        "job": "{$job}",
        "format": "Waiting for alarm time"
    },
    {
        "if": "{$no_alarm}",
        "$class": "redis",
        "$method": "sadd",
        "set": "opxi2:crm_event_list:alarmtime",
        "value": "{$failure.id}"
    },

    {
        "if": "{$in_time}",
        "$class": "util",
        "$method": "clone",
        "from": "{$failure}",
        "$set": "failure_result"
    },
    {
        "if": "{$in_time}",
        "$class": "job",
        "name": "atm_event_notify",
        "title": "{$failure.alarm.title.trans.fa}",
        "data": "{$failure}"
    },

    {
        "if": "{$failure.update}",
        "$class": "util",
        "$method": "clone",
        "from":"{$failure}",
        "$set": "failure_result"
    },
    {
        "if": "{$failure.update}",
        "$class": "wait",
        "secs": 2,
        "$set": "ready_to_process_good"
    },
    {
        "if": "{$ready_to_process_good}",
        "$every": "{$failure.events}",
        "$tasks":[
            {
                "if": "[*every.item.good]",
                "$class": "util",
                "$method": "set",
                "name": ["job_id", "event"],
                "value":["[*every.item.job_id]", "{$job.data}"],
                "$set": "cancel_data"
            },
            {
                "if": "[*cancel_data]",
                "$class": "job",
                "name": "cancel-atm_device_event",
                "title": "[*every.item.job_id]",
                "data": "[*cancel_data]",
                "$set": "cancel_job"
            },
            {
                "$class": "job",
                "$method": "log",
                "job": "{*job}",
                "format": "cancel job: %s",
                "args": [ "[*cancel_job]" ]
            },
            {
                "if": "[*cancel_data]",
                "$class": "atm_event",
                "$method": "update",
                "eventId": "[*every.item.id]",
                "estate": "stopped",
                "status": "fixed"
            },
            {
                "if": "[*every.item.good]",
                "$class": "util",
                "$method": "clone",
                "from": "[*every.item]",
                "$set": "failure_result"
            }
        ]
    },
    {
        "if": "{$failure.ignore}",
        "$class": "util",
        "$method": "clone",
        "from":"{$failure}",
        "$set": "failure_result"
    },
    {
        "if": "{$failure.error_code}",
        "$class": "util",
        "$method": "clone",
        "from":"{$failure}",
        "$set": "failure_result"
    }
]