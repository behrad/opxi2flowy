[
    {
        "$class": "message",
        "$method": "as_multi_dest",
        "data": "{$job.data}",
        "index": "{$job.current_attempt}",
        "$set": "msg"
    },
    {
        "$class": "job",
        "name": "outbound-msg",
        "blocking": true,
        "data": "{$msg}",
        "$set": "outbound_job"
    },
    {
        "if": "{$outbound_job.error}",
        "$class": "util",
        "$method": "clone",
        "from": "{$outbound_job}",
        "$set": "log"
    },
    {
        "if": "{$outbound_job.ok}",
        "$function":"join",
        "$origin":[ "opxi2.outbound.", "{$msg.channel}", ".delivery.*.delivered" ],
        "$args":[""],
        "$set":"delivery_pattern"
    },
    {
        "if": "{$outbound_job.ok}",
        "$class": "redis",
        "$method": "wait_first",
        "pattern": "{$delivery_pattern}",
        "timeout": "{$job.data.answer_timeout}",
        "$set": "dest_response"
    },
    {
        "if": "{$dest_response.timeout}",
        "$class": "util",
        "$method": "clone",
        "from": "{$msg}",
        "$set": "log"
    },
    {
        "if": "{$dest_response.message}",
        "$class": "util",
        "$method": "set",
        "name":  ["answered", "to"],
        "value": [true, "{$msg.to}"],
        "$set": "log"
    }
]