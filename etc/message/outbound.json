[
    {
        "$class": "uuid",
        "$set": "uuid"
    },
    {
        "$class": "message",
        "id": "{$uuid}",
        "outbound": true,
        "data": "{$job.data}",
        "$set": "msgObj"
    },
    {
        "$class": "couch",
        "doc": "{$msgObj}",
        "$set": "msg_log"
    },
    {
        "$function": "console.print",
        "$args": [ "Msg log: ", "{$msg_log}" ]
    },
    {
        "if": "{$msg_log}",
        "$class": "message",
        "$method": "attach_body",
        "message": "{$msgObj}",
        "$set": "attached_msg_ready"
    },
    {
        "if": "{$attached_msg_ready}",
        "$class": "couch",
        "$method": "get",
        "id": "{$uuid}",
        "$set": "msg"
    },
    {
        "$class": "job",
        "name": "send-{$msg.channel}",
        "data": "{$msg}",
        "$set": "send_job"
    },
    {
        "$class": "message",
        "$method": "as_log",
        "action": "send_job",
        "data": "{$send_job}",
        "$set": "logJson"
    },
    {
        "if": "{$logJson}",
        "$class": "couch",
        "$method": "update",
        "id": "{$uuid}",
        "data": "{$logJson}"
    }
]